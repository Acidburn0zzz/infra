---
- name: fetch GIT repo
  become: no
  run_once: true
  git:
    repo: "git@github.com:ipfs/go-ipfs.git"
    force: yes
    update: no
    dest: "/tmp/go-ipfs"
    accept_hostkey: 'yes'
    version: '{{ go_ipfs_version }}'
    depth: 1
  register: code_update

- name: Build base image
  become: no
  run_once: true
  docker_image:
    name: "go-ipfs-ansible:{{ go_ipfs_version }}"
    build:
      path: /tmp/go-ipfs
      pull: yes
    source: build

- name: Build final image with build args
  become: no
  run_once: true
  docker_image:
    name: "go-ipfs:{{ go_ipfs_version }}"
    build:
      path: "{{ role_path }}/files/dockerfiles/"
      pull: no
      args:
        GO_IPFS_VERSION: "{{ go_ipfs_version }}"
    source: build

- name: Archive image
  run_once: true
  become: no
  docker_image:
    name: "go-ipfs"
    tag: "{{ go_ipfs_version }}"
    archive_path: "/tmp/go-ipfs-{{ go_ipfs_version }}.tar"
    source: local
